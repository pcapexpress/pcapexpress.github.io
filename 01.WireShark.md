# PCAPEXPRESS Wireshark Series

## Exercise 01: Download from fake software site

**Platform:** https://www.malware-traffic-analysis.net/
**Pcap file:** 2025-01-22-traffic-analysis-exercise.pcap

#### **Briefing:**

We are a SOC analyst, we are contacted due to a coworker downloading a suspicious file after searching for Google Authenticator. 
We confirm that an infection has occurred, we are supplied a pcap file and tasked to writing an incident report focusing on some key questions written below.
In the mean time the IT department will handle wiping the affected machine. 

#### **LAN SEGMENT DETAILS FROM THE PCAP**
    * LAN segment range:  10.1.17[.]0/24   (10.1.17[.]0 through 10.1.17[.]255)
    * Domain:  bluemoontuesday[.]com
    * Active Directory (AD) domain controller:  10.1.17[.]2 - WIN-GSH54QLW48D
    * AD environment name:  BLUEMOONTUESDAY
    * LAN segment gateway:  10.1.17[.]1
    * LAN segment broadcast address:  10.1.17[.]255

#### **TASK:**
For this exercise, answer the following questions for your incident report:
    * What is the IP address of the infected Windows client?
    * What is the mac address of the infected Windows client?
    * What is the host name of the infected Windows client?
    * What is the user account name from the infected Windows client?
    * What is the likely domain name for the fake Google Authenticator page?
    * What are the IP addresses used for C2 servers for this infection?

#### **Tools:**

Wireshark – pcap inspection
VirusTotal – checking for malicious IPs and Files
CyberChef – decoding malicious traffic
md5sum – calculating file hashes

---

## 00: Prologue

This is my first exercise in a series of working with actual real world malicious network traffic. The pcap file is taken from malware-traffic-analysis.net. The goal is to showcase my thinking in a simple to follow investigation complemented by images. The outcome of the investigation will be checked with the answers provided. There will be mistakes and flaws. I’m trying to show what I can do at the time of writing. A long way to go and no better time than now. Let the Upward Mobility commence. 

---

## 01: Host Discovery

Firstly we attempt to gather more information on the infected host in question.

We can quickly take a look at the endpoint information in the Statistics tab. We check for IPV4 and organize by packets.

<img width="633" height="167" alt="01 Endpoints" src="https://github.com/user-attachments/assets/4fddb25e-526c-477b-b262-0d023af5adb9" />

<small>“01.Endpoints.png”<small>

The leading IP is 10.1.17.215 and the second most interacted with is 5.252.153.241 as will be pointed out soon, this will be malicious.

We have several options to further discover the host details. We can filter for DHCP traffic. Heres a good way to filter or that: “dhcp.option.type == 12”, we are interested in the DHCP Request packet details.

<img width="1178" height="126" alt="02 DHCP request" src="https://github.com/user-attachments/assets/03e2f19b-b680-45bd-9429-1617105b1aa5" />

<small>“02.DHCP request.png”<small>

<img width="517" height="308" alt="03 DHCP details" src="https://github.com/user-attachments/assets/3ff1150b-f4ba-4b57-b8ce-3a1593cb8222" />

<small>“03.DHCP details.png”<small>

> IP Address: 10.1.17.215
> MAC address: Intel_26:4a:74 (00:d0:b7:26:4a:74)
> Host Name: DESKTOP-L8C5GSJ
> Client name: DESKTOP-L8C5GSJ.bluemoontuesday.com

This gives us most of the necessary Host details but one more piece of information can be gathered. We can use the Kerberos protocol traffic to check if a user name is available, for this we filter for “kerberos” and search if we get any data in the CNameString field.

<img width="1187" height="176" alt="04 Kerberos" src="https://github.com/user-attachments/assets/dc319369-61d5-4376-ba8e-62742ad7bc31" />

<small>“04.Kerberos.png”<small>

> User: shutchenson

---

## 02: Examining Traffic

A great way to start would be to check the HTTP and HTTPS traffic minusing the SSDP (Simple Service Discovery Protocol) for unnecessary noise reduction. 

We filter for “(http.request or tls.handshake.type == 1) and !(ssdp)”

We want to see the GET requests first to check for malicious downloads. Which we locate almost immediately. We shall take a look at the downloaded files later. But we see the suspicious fake domains mentioned in the Exercise Briefing.

<img width="1263" height="373" alt="05 Fake domain + GET" src="https://github.com/user-attachments/assets/799da2a2-e6f9-4ba5-94a6-435012f5a99f" />

<small>“05.Fake domain + GET.png”<small>

The suspects are:

> 01. google-authenticator[.]burleson-appliance[.]net
> 02. authenticatoor[.]org
> 03. 5[.]252[.]153[.]241

All three are marked as malicious by VirusTotal. The first 2 are posing as a legitimate authentication website/app. This will go in to our answer section.

When examining the 3d suspect IP we check the Communicating Files section in the Relations tab of VirusTotal and we find that it is known for the 29842.ps1 file.

We discover that file name in the TCP stream of the first GET request from our malicious IP.

<img width="878" height="97" alt="06 First GET TCP stream" src="https://github.com/user-attachments/assets/ca39935a-d27a-4f43-935c-688d1ec6a344" />

<small>“06.First GET TCP stream.png”<small>

The first step appears to be executing a shell script that calls for the malicious file in question to be downloaded. We shall take a look at the TCP stream of the second GET request.

<img width="882" height="322" alt="07 Second GET TCP stream" src="https://github.com/user-attachments/assets/20bb30a4-3875-4411-be30-a5a063cdaf65" />

<small>“07.Second GET TCP stream.png”<small>

We see an obfuscated and encrypted payload. The following string is an indicator of just that: ('F#r[o;m;B[a[s#e#6#4[S;t;r[i;n#g['.replace('#','').replace(';','').replace('[','').The encryption is Base64 and there are characters that can be removed in order to decrypt the payload. So we use CyberChef.

<img width="447" height="379" alt="08 CyberChef decrypted" src="https://github.com/user-attachments/assets/4d831b48-6b47-4a61-b4eb-be747994c50c" />

<small>“08.CyberChef decrypted.png”<small>

I would like to come back later to the payload results to get a better understanding of how the malware is unraveling here. But from my untrained eye it seams like some form of system enumeration with adding a serial number to the particular machine to then sent the data to the Control and Command server. And the attempts to reach out are programmed with 5 second intervals.

<img width="900" height="225" alt="09 GET sequence" src="https://github.com/user-attachments/assets/9f2b11cb-2080-4f4e-983f-8105c4e01134" />

<small>“09.GET sequence.png”<small>

The GET requests are 5 seconds apart. I have checked the TCP stream of the above sequence. The GET requests return a “HTTP/1.1 404 Not Found” until one request gets an “HTTP/1.1 200 OK”. This in turn rolls out a series of commands, to establish our main payload TV.dll and as I would understand to try and hide it among legitimate software, TeamViewer.exe. The VirusTotal information will be provided below.

<img width="810" height="252" alt="10 Main Payload Download" src="https://github.com/user-attachments/assets/4aa194f6-94c3-46ca-a5d9-94eafa079b92" />

<small>“10.Main Payload Download.png ”<small>

I have checked the pas.ps1 file as well and it is identical to the 29842.ps1 we have looked in to before, same obfuscation and base64 string.

We also see that after the file download sequence we see a URL message which will decode in to:

GET /1517096937?k=message = startup shortcut created;  status = success

Perhaps communicating to the C2 server that the payload is deployed successfully.


There is one more discovery that I have initially missed and had to go back to after checking for the exercise answers. There are 2 other C2 servers. They are easy to miss. They appear a few times in the pcap capture. If we filter out the 5.252.153.241 IP we can quickly identify the 2 new IP addresses.

<img width="1132" height="204" alt="11 Filtering Out IP" src="https://github.com/user-attachments/assets/f6ed13f4-b5fb-4e49-8f4c-b44cd41d01bc" />

<small>“11.Filtering Out IP.png ”<small>

Another way is just scrolling through the GET traffic of our “main” malicious IP address we will see the following.

<img width="1135" height="190" alt="12 C2 IPs" src="https://github.com/user-attachments/assets/7a2c1c1a-5dbf-4557-8254-98b73baaa3a3" />

<small>“12.C2 Ips.png”<small>

These are the only other IPs without a host name so they do stick out. We of course check them out with VirusTotal, they both show up as malicious and associated with malware.
I tried checking the TCP stream of the port 2917 packet but its just showing encrypted traffic, with the 443 ones expectedly so.

The verdict here would be that the Command and Control servers are the mentioned above IPs and the likely communication ports for them are 443 and 2917.

> C2 servers: 45[.]125[.]66[.]32 and 45[.]125[.]66[.]252

## 03: Examining Objects

We have determined the files of interest. Using the Object Export function I have gathered the files and ran a md5sum to generate each files hash and than checked each one using VirusTotal. Here are the results:

### **01.File Name: 29842.ps1**

MD5 Hash: ce075aee9430f3a8f2809356f4deca8e
VirusTotal Result: Malicious
Poplar threat label: trojan.powershell/obfuse
BitDefender: Trojan.Generic.38977079


#### **02.File Name: pas.ps1**

MD5 Hash: 10febc686b7035ba0731c85e8e474bcd
VirusTotal Result: Malicious
Poplar threat label: trojan.powershell/malgent
BitDefender: rojan.Generic.38018337


#### **03.File Name: TeamViewer**

MD5 Hash: 9dfa2bd6bddc746acea981da411d59d3
VirusTotal Result: No Threat Detected
File extension: (.exe)


#### **04.File Name: Teamviewer_Resource_fr**

MD5 Hash: 35fa2ce449deb8b93b8ba73bf35e5e7b
VirusTotal Result: No Threat Detected
File extension: (.dll)


#### **05.File Name: TV**

MD5 Hash: 66af1c986968e3bf2a35791e8b55581f
VirusTotal Result: Malicious
Poplar threat label: trojan.doina/malgent
BitDefender: Gen:Variant.Doina.88562
File extension: (.dll)


## 04. Malware Inspection

This space is reserved for later on in my project. My goal is to get a bit of malware analysis going. Using a VM environment. Stay Tuned.

## 05. Short Report and Conclusion

*This is the first exercise for the pcapexpress series. However it was not my first attempt at this particular exercise, it took some time to get my bearings, and the project was abandoned twice at this point. But now I feel quite comfortable navigating WireShark and I must say I’m digging the processes of pcap investigation. Much to learn, much to do.*

We have established that a company employee (host:DESKTOP-L8C5GSJ) has clicked on a link taking them to a fake domain (google-authenticator[.]burleson-appliance[.]net) posing to be a legitimate authentication service provider. 

The employee proceeded downloading a file that upon activation has started a chain reaction of downloading a sequence of files and deploying malware on their machine.

The malware in question is (TV.dll) and it is disguised to trick users to believe it is a piece of legitimate TeamViewer software. The network traffic indicates that some form of persistence has been established and that the infected host is communicating with the adversary using 2 IPs (45.125.66.32 and 45.125.66.252).

The briefing states that the IT department has wiped the affected machine and there is no immediate threat to the organization.

The next procedure would be to update the banned IP addresses and add the Malware hashes to the EDR/Antivirus solution data bank.

Below is a comprehensive collection of data for future use and investigations.

---

### **Compromised Host**

> IP Address: 10.1.17.215
> MAC address: Intel_26:4a:74 (00:d0:b7:26:4a:74)
> Host Name: DESKTOP-L8C5GSJ
> Client name: DESKTOP-L8C5GSJ.bluemoontuesday.com
> User Name: shutchenson

### **Attackers**

* Fake domain 01: google-authenticator[.]burleson-appliance[.]net
* Fake domain 02: authenticatoor[.]org

C2 Server 01: 5[.]252[.]153[.]241
C2 Server 02: 45[.]125[.]66[.]32
C2 Server 03: 45[.]125[.]66[.]252

### **Malware MD5 Hashes**

TV.dll - <small>66af1c986968e3bf2a35791e8b55581f<small>
29842.ps1 - <small>ce075aee9430f3a8f2809356f4deca8e<small>
pas.ps1 - <small>10febc686b7035ba0731c85e8e474bcd<small>

---

This will conclude the first exercise in the series. See you in the next one!
